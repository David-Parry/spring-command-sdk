services:
  # Base Image Builder (run occasionally with: docker compose --profile build-base build base-builder)
  base-builder:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    image: qodo/command-sdk-base:latest
    container_name: qodo-base-builder
    profiles: ["build-base"]
    command: echo "Base image built successfully"

  # Apache ActiveMQ Service
  activemq:
    image: apache/activemq-classic:6.1.4
    container_name: qodo-activemq
    ports:
      - "61616:61616"  # OpenWire protocol (JMS)
      - "8161:8161"    # Web Console
    environment:
      ACTIVEMQ_USERNAME: ${ACTIVEMQ_USERNAME:-qodo}
      ACTIVEMQ_PASSWORD: ${ACTIVEMQ_PASSWORD:-qodo}
      ACTIVEMQ_ADMIN_LOGIN: ${ACTIVEMQ_ADMIN_LOGIN:-admin}
      ACTIVEMQ_ADMIN_PASSWORD: ${ACTIVEMQ_ADMIN_PASSWORD:-admin}
      ACTIVEMQ_WEBADMIN_LOGIN: ${ACTIVEMQ_WEBADMIN_LOGIN:-admin}
      ACTIVEMQ_WEBADMIN_PASSWORD: ${ACTIVEMQ_WEBADMIN_PASSWORD:-admin}
    # Explicit ephemeral storage using tmpfs (in-memory, faster, lost on container stop)
    tmpfs:
      - /opt/apache-activemq/data:size=1G
    networks:
      - qodo-network
    healthcheck:
      test: ["CMD", "curl", "-f", "-u", "admin:admin", "http://localhost:8161/admin/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Spring Boot Application
  command-sdk:
    build:
      context: ..
      dockerfile: docker/Dockerfile.app
      cache_from:
        - qodo/command-sdk-base:latest
        - qodo/command-sdk:latest
      args:
        BUILDKIT_INLINE_CACHE: 1
    image: qodo/command-sdk:${VERSION:-latest}
    container_name: command-sdk-app
    ports:
      - "${SERVER_PORT:-8081}:8081"
    environment:
      # Server Configuration
      SERVER_PORT: 8081
      
      # Qodo Configuration
      COMMAND_BASE_URL: ${COMMAND_BASE_URL:-https://api.command.qodo.ai}
      QODO_BLOCKED_TOOLS: ${QODO_BLOCKED_TOOLS:-scout-linux-server:dependencies_list,restricted_command}
      QODO_AGENT_CONFIG_FILE: ${QODO_AGENT_CONFIG_FILE:-classpath:agent.yml}
      QODO_MCP_REQUEST_TIMEOUT_SECONDS: ${QODO_MCP_REQUEST_TIMEOUT_SECONDS:-300}
      QODO_METRICS_CACHE_MAX_SIZE: ${QODO_METRICS_CACHE_MAX_SIZE:-5000}
      QODO_METRICS_CACHE_EXPIRE_MINUTES: ${QODO_METRICS_CACHE_EXPIRE_MINUTES:-30}
      # WebSocket Configuration
      WEBSOCKET_TOKEN: ${WEBSOCKET_TOKEN}

      GITHUB_API_TOKEN: ${GITHUB_API_TOKEN}

      SNYK_TOKEN: ${SNYK_TOKEN}

      # Snyk Webhook Configuration
      SNYK_WEBHOOK_SECRET: ${SNYK_WEBHOOK_SECRET:-lower-test-token-replace}
      SNYK_WEBHOOK_VALIDATION_ENABLED: ${SNYK_WEBHOOK_VALIDATION_ENABLED:-false}
      
      # Jira Webhook Configuration
      JIRA_WEBHOOK_SECRET: ${JIRA_WEBHOOK_SECRET:-lower-test-token-replace}
      JIRA_WEBHOOK_VALIDATION_ENABLED: ${JIRA_WEBHOOK_VALIDATION_ENABLED:-false}
      JIRA_AGENT_ACCOUNT_ID: ${JIRA_AGENT_ACCOUNT_ID}

      # Atlassian/Confluence Configuration
      ATLASSIAN_JIRA_USERNAME: ${ATLASSIAN_EMAIL}
      ATLASSIAN_JIRA_URL: ${ATLASSIAN_SITE_URL}
      ATLASSIAN_JIRA_API_TOKEN: ${ATLASSIAN_API_TOKEN}
      
      # MCP Atlassian Configuration
      MCP_ATLASSIAN_HOST: mcp-atlassian
      
      # Messaging Configuration - ActiveMQ
      MESSAGING_PROVIDER: ${MESSAGING_PROVIDER:-activemq}
      MESSAGING_DEFAULT_TOPIC: ${MESSAGING_DEFAULT_TOPIC:-audit}
      MESSAGING_EVENT_TOPIC: ${MESSAGING_EVENT_TOPIC:-event}
      MESSAGING_RESPONSE_TOPIC: ${MESSAGING_RESPONSE_TOPIC:-response}
      
      # ActiveMQ Connection
      MESSAGING_ACTIVEMQ_BROKER_URL: tcp://activemq:61616
      MESSAGING_ACTIVEMQ_USERNAME: ${ACTIVEMQ_USERNAME:-qodo}
      MESSAGING_ACTIVEMQ_PASSWORD: ${ACTIVEMQ_PASSWORD:-qodo}
      
      # JMS Health Check (disable when using local queue)
      JMS_HEALTH_ENABLED: ${JMS_HEALTH_ENABLED:-true}
      
      # Local Queue Configuration (when MESSAGING_PROVIDER=local)
      LOCAL_QUEUE_CAPACITY: ${LOCAL_QUEUE_CAPACITY:-1000}
      LOCAL_CONSUMER_THREADS: ${LOCAL_CONSUMER_THREADS:-1}
      LOCAL_RETRY_ATTEMPTS: ${LOCAL_RETRY_ATTEMPTS:-3}
      LOCAL_RETRY_DELAY_MS: ${LOCAL_RETRY_DELAY_MS:-1000}
      LOCAL_MAX_RETRY_DELAY_MS: ${LOCAL_MAX_RETRY_DELAY_MS:-30000}
      LOCAL_POLL_TIMEOUT_SECONDS: ${LOCAL_POLL_TIMEOUT_SECONDS:-5}
      LOCAL_EXPONENTIAL_BACKOFF: ${LOCAL_EXPONENTIAL_BACKOFF:-true}

      GIT_SSH_PRIVATE_KEY: ${GIT_SSH_PRIVATE_KEY:-MISSING}

      # Logging Configuration
      LOGGING_LEVEL_AI_QODO_COMMAND_INTERNAL: ${LOGGING_LEVEL_AI_QODO_COMMAND_INTERNAL:-INFO}

      # JVM Options
      JAVA_OPTS: ${JAVA_OPTS:--XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0}
    depends_on:
      activemq:
        condition: service_healthy
    networks:
      - qodo-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    volumes:
      - ${HOME}/code/docker_mnt/compose-command-sdk/command-sdk:/app/data
    restart: unless-stopped
  # --- new ---
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    depends_on:
      - command-sdk
    networks:
      - qodo-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: "error"
    volumes:
      - ./monitoring/grafana-provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    tmpfs:
      - /var/lib/grafana:size=256m
    depends_on:
      - prometheus
    networks:
      - qodo-network
    restart: unless-stopped

networks:
  qodo-network:
    driver: bridge

volumes:
  # Persistent volumes for monitoring stack
  prometheus_data:
    driver: local
  grafana_data:
    driver: local

# Note: ActiveMQ uses ephemeral tmpfs storage - no persistent volume
