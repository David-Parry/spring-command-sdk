# Docker Compose configuration for LOCAL QUEUE (no ActiveMQ)
# 
# Usage:
#   docker-compose -f docker-compose.local.yml up
#
# This configuration:
# - Does NOT start ActiveMQ
# - Uses local in-memory queue
# - Includes monitoring (Prometheus & Grafana)

services:
  # Spring Boot Application with Local Queue
  command-sdk:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: command-sdk:${VERSION:-latest}
    container_name: command-sdk-app
    ports:
      - "${SERVER_PORT:-8081}:8081"
    environment:
      # Server Configuration
      SERVER_PORT: 8081
      
      # Qodo Configuration
      COMMAND_BASE_URL: ${COMMAND_BASE_URL:-https://api.command.qodo.ai}
      QODO_BLOCKED_TOOLS: ${QODO_BLOCKED_TOOLS:-scout-linux-server:dependencies_list,restricted_command}
      QODO_AGENT_CONFIG_FILE: ${QODO_AGENT_CONFIG_FILE:-classpath:agent.yml}
      QODO_MCP_REQUEST_TIMEOUT_SECONDS: ${QODO_MCP_REQUEST_TIMEOUT_SECONDS:-300}
      QODO_METRICS_CACHE_MAX_SIZE: ${QODO_METRICS_CACHE_MAX_SIZE:-5000}
      QODO_METRICS_CACHE_EXPIRE_MINUTES: ${QODO_METRICS_CACHE_EXPIRE_MINUTES:-30}
      
      # WebSocket Configuration
      WEBSOCKET_TOKEN: ${WEBSOCKET_TOKEN}
      GITHUB_API_TOKEN: ${GITHUB_API_TOKEN}
      
      # Snyk Webhook Configuration
      SNYK_WEBHOOK_SECRET: ${SNYK_WEBHOOK_SECRET:-lower-test-token-replace}
      SNYK_WEBHOOK_VALIDATION_ENABLED: ${SNYK_WEBHOOK_VALIDATION_ENABLED:-false}
      
      # Jira Webhook Configuration
      JIRA_WEBHOOK_SECRET: ${JIRA_WEBHOOK_SECRET:-lower-test-token-replace}
      JIRA_WEBHOOK_VALIDATION_ENABLED: ${JIRA_WEBHOOK_VALIDATION_ENABLED:-false}
      JIRA_AGENT_ACCOUNT_ID: ${JIRA_AGENT_ACCOUNT_ID}

      # Atlassian/Confluence Configuration
      ATLASSIAN_JIRA_USERNAME: ${ATLASSIAN_EMAIL}
      ATLASSIAN_JIRA_URL: ${ATLASSIAN_SITE_URL}
      ATLASSIAN_JIRA_API_TOKEN: ${ATLASSIAN_API_TOKEN}
      
      # MCP Atlassian Configuration
      MCP_ATLASSIAN_HOST: mcp-atlassian

      SNYK_TOKEN: ${SNYK_API_TOKEN}
      # Messaging Configuration - LOCAL QUEUE
      MESSAGING_PROVIDER: local
      MESSAGING_DEFAULT_TOPIC: ${MESSAGING_DEFAULT_TOPIC:-audit}
      MESSAGING_EVENT_TOPIC: ${MESSAGING_EVENT_TOPIC:-event}
      MESSAGING_RESPONSE_TOPIC: ${MESSAGING_RESPONSE_TOPIC:-response}
      
      # JMS Health Check - DISABLED for local queue
      JMS_HEALTH_ENABLED: false
      
      # Local Queue Configuration
      LOCAL_QUEUE_CAPACITY: ${LOCAL_QUEUE_CAPACITY:-1000}
      LOCAL_CONSUMER_THREADS: ${LOCAL_CONSUMER_THREADS:-1}
      LOCAL_RETRY_ATTEMPTS: ${LOCAL_RETRY_ATTEMPTS:-3}
      LOCAL_RETRY_DELAY_MS: ${LOCAL_RETRY_DELAY_MS:-1000}
      LOCAL_MAX_RETRY_DELAY_MS: ${LOCAL_MAX_RETRY_DELAY_MS:-30000}
      LOCAL_POLL_TIMEOUT_SECONDS: ${LOCAL_POLL_TIMEOUT_SECONDS:-5}
      LOCAL_EXPONENTIAL_BACKOFF: ${LOCAL_EXPONENTIAL_BACKOFF:-true}

      # Git SSH Configuration
      GIT_SSH_PRIVATE_KEY: ${GIT_SSH_PRIVATE_KEY:-MISSING}

      # Logging Configuration
      LOGGING_LEVEL_AI_QODO_COMMAND_INTERNAL: ${LOGGING_LEVEL_AI_QODO_COMMAND_INTERNAL:-INFO}

      # JVM Options
      JAVA_OPTS: ${JAVA_OPTS:--XX:+UseContainerSupport -XX:MaxRAMPercentage=75.0}
    
    # NO dependency on ActiveMQ
    networks:
      - qodo-network
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    volumes:
      - ${HOME}/code/docker_mnt/compose-command-sdk/command-sdk:/app/data
    restart: unless-stopped

  # Prometheus for metrics
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.enable-lifecycle"
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    depends_on:
      - command-sdk
    networks:
      - qodo-network
    restart: unless-stopped

  # Grafana for dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_LOG_LEVEL: "error"
    volumes:
      - ./monitoring/grafana-provisioning/datasources:/etc/grafana/provisioning/datasources:ro
      - ./monitoring/grafana-provisioning/dashboards:/etc/grafana/provisioning/dashboards:ro
    tmpfs:
      - /var/lib/grafana:size=256m
    depends_on:
      - prometheus
    networks:
      - qodo-network
    restart: unless-stopped

networks:
  qodo-network:
    driver: bridge

volumes:
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
